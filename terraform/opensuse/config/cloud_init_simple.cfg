#cloud-config
hostname: ${hostname}
fqdn: ${fqdn}

users:
  - default
  - name: vicente
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: $6$rounds=4096$saltsalt$UiZikbV3VeeBPiYlSKwb0JZ7xzB6V7P7IOLpL4lFvR4FdGV8K7QW5LT1P1DWG5nJQjG2WE1P7Y8L8DK8Q7V9Z0
    groups: [wheel, users]
    ssh_authorized_keys:
      - ${public_key}

ssh_pwauth: true
disable_root: false

chpasswd:
  list: |
    vicente:123
    root:123
  expire: false

packages:
  - openssh-server
  - wget
  - curl
  - python3
  - qemu-guest-agent

# ⚠️ IMPORTANTE: openSUSE NO usa Netplan
# Debemos crear los archivos ifcfg-* para wicked
write_files:
  - path: /etc/sysconfig/network/ifcfg-eth0
    permissions: '0644'
    content: |
      BOOTPROTO='static'
      IPADDR='172.16.25.2'
      NETMASK='255.255.255.0'
      GATEWAY='172.16.25.1'
      NAME='eth0'
      STARTMODE='auto'

  - path: /etc/sysconfig/network/ifcfg-eth1
    permissions: '0644'
    content: |
      BOOTPROTO='dhcp'
      STARTMODE='auto'

runcmd:
  # Recargar red usando wicked
  - systemctl restart wicked
  - wicked ifreload all

  # Ajustes de SSH
  - sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart sshd
  - systemctl enable sshd

  # -------- QEMU Guest Agent FIX REAL PARA OPENSUSE --------
  - systemctl enable qemu-guest-agent.service
  - systemctl restart qemu-guest-agent.service
  - systemctl enable qemu-ga.service || true
  - systemctl restart qemu-ga.service || true
  - systemctl status qemu-guest-agent.service || true
  # ----------------------------------------------------------

final_message: "Sistema listo - SSH y red configurados para openSUSE"
